<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact Picker — Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 24px; max-width: 720px; margin: auto; }
    .card { border: 1px solid #e6e6e6; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    button { padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; }
    #pickBtn { background: #0b5fff; color: white; }
    #fallbackForm { margin-top: 12px; display: none; }
    .field { display:flex; gap:8px; margin-bottom:8px; }
    label { min-width:80px; font-weight:600; }
    input { flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .hint { color:#666; font-size:0.9rem; margin-top:8px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <h1>Selector de contactos (Contact Picker API)</h1>

  <div class="card">
    <p>Pulsa el botón para seleccionar un contacto desde el dispositivo. Si tu navegador no lo soporta verás un formulario para introducir los datos manualmente.</p>

    <div style="display:flex; gap:10px; align-items:center;">
      <button id="pickBtn">Seleccionar contacto</button>
      <button id="openFallbackBtn" style="background:#e6e6e6;">Usar formulario (fallback)</button>
    </div>

    <div id="result" class="hint" aria-live="polite" style="margin-top:12px;"></div>

    <form id="fallbackForm" novalidate>
      <div class="field">
        <label for="name">Nombre</label>
        <input id="name" name="name" type="text" placeholder="Nombre completo" />
      </div>
      <div class="field">
        <label for="tel">Teléfono</label>
        <input id="tel" name="tel" type="tel" placeholder="+52 1 55..." />
      </div>
      <div class="field">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="ejemplo@mail.com" />
      </div>
      <div style="display:flex; gap:8px;">
        <button id="saveFallback" type="button" style="background:#10a37f; color:white;">Guardar</button>
        <button id="cancelFallback" type="button" style="background:#f0f0f0;">Cancelar</button>
      </div>
    </form>

    <h3 style="margin-top:16px">Respuesta cruda</h3>
    <pre id="raw">—</pre>
  </div>

  <script>
    (function () {
      const pickBtn = document.getElementById('pickBtn');
      const openFallbackBtn = document.getElementById('openFallbackBtn');
      const fallbackForm = document.getElementById('fallbackForm');
      const saveFallback = document.getElementById('saveFallback');
      const cancelFallback = document.getElementById('cancelFallback');
      const result = document.getElementById('result');
      const raw = document.getElementById('raw');

      // Campos solicitados al Contact Picker
      const props = ['name', 'email', 'tel'];
      const opts = { multiple: false }; // cambiar a true si quieres permitir varios

      // Detectar soportes seguro
      const supportsContactPicker = ('contacts' in navigator) && (typeof navigator.contacts.select === 'function');

      // UI inicial según soporte
      if (!supportsContactPicker) {
        result.textContent = 'Contact Picker no disponible en este navegador. Se mostrará el formulario de fallback si lo deseas.';
      } else {
        result.textContent = 'Contact Picker disponible. Pulsa "Seleccionar contacto".';
      }

      // Acción: abrir selector (DEBE ser desde un gesto de usuario)
      pickBtn.addEventListener('click', async () => {
        // Siempre asegurar que la función exista (evita errores en navegadores "parciales")
        if (!supportsContactPicker) {
          showFallback();
          return;
        }

        try {
          // navigator.contacts.select devuelve un array de contactos seleccionados
          const contacts = await navigator.contacts.select(props, opts);

          // contacts puede llegar vacío si el usuario cancela, o con campos vacíos
          if (!contacts || contacts.length === 0) {
            result.textContent = 'No seleccionaste ningún contacto (cancelado).';
            raw.textContent = '[]';
            return;
          }

          // Normalizar y mostrar el primer contacto
          const c = contacts[0];

          // name/email/tel suelen venir como arrays en el objeto (según implementaciones)
          const name = Array.isArray(c.name) ? c.name[0] : c.name || '';
          const email = Array.isArray(c.email) ? c.email[0] : c.email || '';
          const tel = Array.isArray(c.tel) ? c.tel[0] : c.tel || '';

          // Poner en UI y en el formulario fallback (para edición/guardar)
          result.innerHTML = `<strong>Seleccionado:</strong> ${escapeHtml(name || '—')} ${escapeHtml(tel ? '· ' + tel : '')} ${escapeHtml(email ? '· ' + email : '')}`;
          raw.textContent = JSON.stringify(contacts, null, 2);

          // Llenar fallback por si quieres guardarlo desde ahí
          document.getElementById('name').value = name || '';
          document.getElementById('tel').value  = tel || '';
          document.getElementById('email').value = email || '';

        } catch (err) {
          // Errores: permisos, cancelación, o restricciones (p.ej. top-level required)
          console.error('Contact picker error:', err);
          result.textContent = 'Ocurrió un error o el usuario canceló la selección. Mira la consola para más detalles.';
          raw.textContent = String(err && err.message ? err.message : err);
        }
      });

      // Abrir fallback manualmente
      openFallbackBtn.addEventListener('click', showFallback);
      cancelFallback.addEventListener('click', () => {
        fallbackForm.style.display = 'none';
      });

      // Guardar datos del fallback (ejemplo: sólo los mostrará)
      saveFallback.addEventListener('click', () => {
        const name = document.getElementById('name').value.trim();
        const tel  = document.getElementById('tel').value.trim();
        const email = document.getElementById('email').value.trim();

        if (!name && !tel && !email) {
          alert('Introduce al menos un dato.');
          return;
        }

        const saved = { name, tel, email, from: 'fallback' };
        result.innerHTML = `<strong>Guardado manualmente:</strong> ${escapeHtml(name)} ${escapeHtml(tel ? '· ' + tel : '')} ${escapeHtml(email ? '· ' + email : '')}`;
        raw.textContent = JSON.stringify(saved, null, 2);

        // Aquí iría tu lógica real: enviar al servidor, guardar en IndexedDB, etc.
        fallbackForm.style.display = 'none';
      });

      function showFallback() {
        fallbackForm.style.display = 'block';
        result.textContent = 'Introduce manualmente los datos en el formulario.';
      }

      // Pequeña función para evitar inyección al mostrar texto
      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
      }

    })();
  </script>
</body>
</html>
